<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Softupkaran Admin</title>
    <style>
      :root{
        --bg:#0a0f1f;
        --bg-2:#0c152a;
        --panel:#111a2f;
        --panel-2:#0f1a35;
        --text:#eef2ff;
        --muted:#9aa4b2;
        --accent:#38bdf8;
        --accent-2:#22c55e;
        --border:#233152;
        --shadow:0 18px 40px rgba(0,0,0,.45);
        --radius:16px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        background:
          radial-gradient(900px 600px at 15% 10%, rgba(56,189,248,.18), transparent 60%),
          radial-gradient(700px 500px at 90% 80%, rgba(34,197,94,.12), transparent 60%),
          linear-gradient(130deg, var(--bg), var(--bg-2));
        color:var(--text);
      }
      header{
        position:sticky; top:0; z-index:5;
        backdrop-filter: blur(8px);
        background: rgba(10,15,31,.75);
        border-bottom:1px solid var(--border);
      }
      .header-inner{
        max-width:1200px; margin:0 auto; padding:18px 24px;
        display:flex; align-items:center; justify-content:space-between; gap:16px;
      }
      .brand{
        display:flex; flex-direction:column; gap:4px;
      }
      .brand h1{margin:0; font-size:20px; letter-spacing:.3px}
      .brand span{color:var(--muted); font-size:12px}
      .actions{display:flex; gap:10px; align-items:center}
      button{
        background:var(--panel);
        border:1px solid var(--border);
        color:var(--text);
        border-radius:12px;
        padding:10px 14px;
        cursor:pointer;
      }
      button:hover{border-color:var(--accent)}
      input{
        background:var(--panel);
        border:1px solid var(--border);
        color:var(--text);
        border-radius:12px;
        padding:10px 12px;
        min-width:220px;
      }
      main{max-width:1200px;margin:0 auto;padding:28px 24px 60px}
      .grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:18px}
      .stat{
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:var(--radius);
        padding:16px;
        box-shadow:var(--shadow);
      }
      .stat h3{margin:0 0 6px; font-size:13px; color:var(--muted); font-weight:600}
      .stat p{margin:0; font-size:22px; font-weight:700}
      .card{
        background:var(--panel-2);
        border:1px solid var(--border);
        border-radius:var(--radius);
        padding:16px;
        box-shadow:var(--shadow);
      }
      .toolbar{
        display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
        margin-bottom:12px;
      }
      .toolbar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
      .pill{
        background:rgba(56,189,248,.12);
        color:#bae6fd;
        border:1px solid rgba(56,189,248,.35);
        border-radius:999px;
        padding:4px 10px;
        font-size:12px;
      }
      table{width:100%; border-collapse:collapse}
      th,td{
        border-bottom:1px solid #1f2b46;
        padding:10px 8px;
        text-align:left;
        font-size:13px;
      }
      th{color:#cbd5f5; font-weight:600}
      tr:hover td{background:#0f1a35}
      code{
        background:#0a1226;
        border:1px solid #1c2842;
        border-radius:8px;
        padding:2px 6px;
        color:#c7d2fe;
      }
      .muted{color:var(--muted); font-size:12px}
      .danger{
        background:#ef4444;
        border:1px solid #f87171;
        color:#0b1020;
      }
      .danger:hover{filter:brightness(1.05)}
      @media (max-width:900px){
        .grid{grid-template-columns:1fr}
        .actions{width:100%}
        input{width:100%}
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-inner">
        <div class="brand">
          <h1>Crick6 Console</h1>
          <span>Live signup feed and user lookup</span>
        </div>
        <div class="actions">
          <input id="q" placeholder="Search name, email, telegram" />
          <button id="refresh">Refresh</button>
          <button id="exportCsv">Export CSV</button>
          <button id="logout">Log out</button>
        </div>
      </div>
    </header>

    <main>
      <section class="grid" aria-label="Summary">
        <div class="stat">
          <h3>Total users</h3>
          <p id="statTotal">0</p>
        </div>
        <div class="stat">
          <h3>Latest signup</h3>
          <p id="statLatest">-</p>
        </div>
        <div class="stat">
          <h3>Status</h3>
          <p id="statStatus">Online</p>
        </div>
      </section>

      <section class="card">
        <div class="toolbar">
          <div class="left">
            <span class="pill">API: /api/users</span>
            <span id="summary" class="muted">Loading...</span>
          </div>
          <span class="muted">Telegram is required for every account.</span>
        </div>

        <div style="overflow:auto;">
          <table id="users">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Email</th>
                <th>Telegram</th>
                <th>WhatsApp</th>
                <th>Password</th>
                <th>Created</th>
                <th>ID</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      function formatDate(value) {
        if (!value) return '-';
        try { return new Date(value).toLocaleString(); }
        catch (e) { return value; }
      }

      async function load() {
        const res = await fetch('/api/users');
        const data = await res.json();
        const q = document.getElementById('q').value.trim().toLowerCase();
        let users = data.users || [];
        if (q) {
          users = users.filter(u =>
            (u.email||'').toLowerCase().includes(q) ||
            (u.name||'').toLowerCase().includes(q) ||
            (u.telegram||'').toLowerCase().includes(q)
          );
        }

        document.getElementById('statTotal').textContent = users.length.toString();
        const latest = users.slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
        document.getElementById('statLatest').textContent = latest ? formatDate(latest.createdAt) : '-';
        document.getElementById('summary').textContent = `Showing ${users.length} user(s)`;

        const tbody = document.querySelector('#users tbody');
        tbody.innerHTML = '';
        users.forEach((u, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${u.name||''}</td>
            <td>${u.email||''}</td>
            <td>${u.telegram||''}</td>
            <td>${u.whatsapp||''}</td>
            <td><code>${u.password||''}</code></td>
            <td>${formatDate(u.createdAt)}</td>
            <td><code>${u.id||''}</code></td>
            <td><button class="danger" data-id="${u.id||''}">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-id]').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (!id) return;
            if (!confirm('Delete this user? This cannot be undone.')) return;
            const res = await fetch(`/api/users/${encodeURIComponent(id)}`, { method: 'DELETE' });
            if (!res.ok) {
              const err = await res.json().catch(() => ({ error: 'Delete failed' }));
              alert(err.error || 'Delete failed');
              return;
            }
            load();
          });
        });
      }

      document.getElementById('refresh').addEventListener('click', load);
      document.getElementById('q').addEventListener('input', load);
      document.getElementById('exportCsv').addEventListener('click', () => {
        window.location.href = '/api/export?format=csv';
      });
      document.getElementById('logout').addEventListener('click', async () => {
        await fetch('/admin/logout', { method: 'POST' });
        window.location.href = '/admin/login';
      });
      load();
    </script>
  </body>
</html>
